name: Zvec MacArm64 CI

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - '**.md'
  merge_group:
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - '**.md'
  workflow_dispatch:

concurrency:
  group: pr-${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build:
    name: Zvec MacArm64 CI
    runs-on: macos-15

    strategy:
      matrix:
        python-version: ['3.10']
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: 'pyproject.toml'

      - name: Set up environment variables
        run: |
          # Set number of processors for parallel builds
          NPROC=$(sysctl -n hw.ncpu 2>/dev/null || echo 2)
          echo "NPROC=$NPROC" >> $GITHUB_ENV
          echo "Using $NPROC parallel jobs for builds"
          
          # Add Python user base bin to PATH for pip-installed CLI tools
          echo "$(python -c 'import site; print(site.USER_BASE)')/bin" >> $GITHUB_PATH
        shell: bash

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip \
            ruff==v0.14.4 \
            clang-format==18.1.8 \
            pybind11==3.0 \
            cmake==3.30.0 \
            ninja==1.11.1 \
            pytest \
            pytest-cov \
            scikit-build-core \
            setuptools_scm
        shell: bash

      - name: Run Ruff Linter
        run: |
          cd "$GITHUB_WORKSPACE"
          python -m ruff check .
        shell: bash

      - name: Run Ruff Formatter Check
        run: |
          cd "$GITHUB_WORKSPACE"
          python -m ruff format --check .
        shell: bash

      - name: Run clang-format Check
        run: |
          cd "$GITHUB_WORKSPACE"

          CPP_FILES=$(find . -type f \( -name "*.cpp" -o -name "*.h" -o -name "*.hpp" -o -name "*.cc" -o -name "*.cxx" \) \
            ! -path "./build/*" \
            ! -path "./tests/*" \
            ! -path "./scripts/*" \
            ! -path "./python/*" \
            ! -path "./thirdparty/*" \
            ! -path "./.git/*")

          if [ -z "$CPP_FILES" ]; then
            echo "No C++ files found to check."
            exit 0
          fi

          clang-format --dry-run --Werror $CPP_FILES
        shell: bash

      - name: Build from source
        run: |
          cd "$GITHUB_WORKSPACE"
          
          CMAKE_GENERATOR="Unix Makefiles" \
          CMAKE_BUILD_PARALLEL_LEVEL="$NPROC" \
          python -m pip install -v . \
            --no-build-isolation \
            --config-settings='cmake.define.BUILD_TOOLS="ON"'
        shell: bash

      - name: Run Cpp Tests
        run: |
          cd "$GITHUB_WORKSPACE/build"
          make unittest -j$NPROC
        shell: bash

      - name: Run Python Tests with Coverage
        run: |
          cd "$GITHUB_WORKSPACE"
          python -m pytest python/tests/ --cov=zvec --cov-report=xml --no-cov-on-fail
        shell: bash


      - name: Run Cpp Examples
        run: |
          cd "$GITHUB_WORKSPACE/examples/c++"
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          make -j $NPROC && ./db-example && ./core-example && ./ailego-example
        shell: bash
